events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 8080;
        server_name _;

        # -------------------------------------------------------
        # 1. SERVE MAIN REACT APP (Landing Page)
        # -------------------------------------------------------
        root /usr/share/nginx/html; # Set global root for the main app
        
        location / {
            # First check if the file exists (e.g., style.css), 
            # if not, serve index.html (for React Router paths like /about, /contact)
            try_files $uri $uri/ /index.html;
        }

        # -------------------------------------------------------
        # 2. PROXY TO TEST ONE (External App)
        # -------------------------------------------------------
        location /testone/ {
            # Rewrite URL to remove /testone/ prefix before sending to backend
            rewrite ^/testone/(.*) /$1 break;
            
            proxy_pass https://ai-club-dot-circle4life-dev.uc.r.appspot.com;
            proxy_set_header Host ai-club-dot-circle4life-dev.uc.r.appspot.com;
            
            # Standard Proxy Headers
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # SSL Handling for external HTTPS targets
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            
            # Prevent redirects from breaking the proxy
            proxy_redirect off;
        }

        # -------------------------------------------------------
        # 3. PROXY TO TEST TWO (External App)
        # -------------------------------------------------------
        location /testtwo/ {
            rewrite ^/testtwo/(.*) /$1 break;
            
            proxy_pass https://aiclub-dot-circle4life-dev.uc.r.appspot.com;
            proxy_set_header Host aiclub-dot-circle4life-dev.uc.r.appspot.com;
            
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            proxy_redirect off;
        }
    }
}